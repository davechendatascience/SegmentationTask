# SegmentationTask

This project provides two ways to train/evaluate the CLIP + Mask2Former‑style panoptic segmentation model:
- A Colab notebook (`panoptic_segmentation.ipynb`)
- A local training script (`train_local.py`)

## Colab Usage

1. Open `panoptic_segmentation.ipynb` in Colab.
2. Run the setup cell to install dependencies.
3. Run the training cell.

Notes:
- The notebook auto-downloads ADE20k if it is not present.
- Validation uses `evaluate_model` from `core_design/eval_block.py`.

## Local Usage

### 1. Environment Setup

Use the provided setup script to install dependencies (including `torch-linear-assignment` with `--no-build-isolation`):

```bash
bash setup_env.sh
```

### 2. Train Locally

```bash
python train_local.py --data-root /path/to/ADEChallengeData2016
```

### 3. Common Flags

```bash
# Example
python train_local.py \
  --epochs 20 \
  --batch-size 4 \
  --eval-every 1 \
  --save-path clip_panoptic_lora.pth
```

Useful options:
- `--compile / --no-compile` to toggle `torch.compile`.
- `--use-torch-lap / --no-torch-lap` to toggle GPU linear assignment.
- `--mask-size` to change downsampled mask size used in matching/loss.
- `--hier-warmup-epochs`, `--w-parent-start`, `--w-kl-start` to control the KL/hierarchy warm‑up schedule.

### 4. Evaluate Validation Metrics (All Samples)

`core_design` (CLIP + LightMask2Former):

```bash
python scripts/eval_validation.py \
  --core core_design \
  --data-dir /path/to/ADEChallengeData2016 \
  --checkpoint /path/to/clip_panoptic_lora.pth
```

`core_design_2` (HF Mask2Former):

```bash
python scripts/eval_validation.py \
  --core core_design_2 \
  --data-dir /path/to/ADEChallengeData2016 \
  --run-dir runs/mask2former_ade20k/best
```

These commands report **PQ / SQ / RQ** (panoptic quality metrics).

## Project Structure

- `core_design/` — dataset, model, loss, eval, and training blocks
- `core_design_2/` — Mask2Former (HF) training pipeline
- `train_local.py` — local training entrypoint
- `panoptic_segmentation.ipynb` — Colab notebook (generated by `create_ipynb.py`)
- `setup_env.sh` — installs deps with the correct build flags


